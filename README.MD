# Backend de la aplicaci贸n

Este documento refleja como trabajar el backend de la aplicaci贸n.

version 2.0
Jogeiker L <jogeiker1999@gmail.com>
(c) Sapviremoto

# Conexi贸n a la instancia AWS

Para conectarnos al repositorio remoto usamos git y ssh con el certificado kudiskaServer.pem:

Dominio : www.sportyeah.com
usuario : ubuntu
ppk : sportyeah.ppk

ssh -i sportyeah.pem ubuntu@sportyeah.com


## Crear una carpeta para los repositorios

mkdir /home/user/kudiska

Hemos creado la carpeta kudiska en la carpeta de nuestro usuario.

## Crear el repositorio de Frontend

cd /home/user/kudiska

Clonamos el repositorio del frontend:

git clone git+ssh://ubuntu@kudiska.com/var/git/frontend.git

Ahora en:

cd /home/user/kudiska/frontend

Tenemos el frontend de la aplicaci贸n.

Podemos utilizar un cliente git o bien:

git commit -m "my commit"       Para confirmar los cambios en nuestro repositorio local
git push                        Para enviar los cambios al repositorio remoto

## Clonar el repositorio de Backend

cd /home/user/kudiska

Clonamos el repositorio del backend:

git clone git+ssh://ubuntu@kudiska.com/var/git/backend.git

Ahora en:
cd /home/user/kudiska/backend

# Estructura baica

La carpeta /src contiene el c贸digo fuente de la aplicaci贸n.
La carpeta /build contiene la aplicaci贸n compilada.
El archivo package.json contiene las dependencias del proyecto

## Compilar el proyecto 

En desarrollo ejecutar:

npm run tsc

Para iniciar el compilador de typescript.

## Hacer un build

El proyecto contiene otros recursos que no se compilan:

app.config      El archivo de configuraci贸n de la aplicaci贸n.
/src/views      Las vistas utilizadas por el motor de plantllas hbs

Cuando se compila (se hace un build del proyecto), adem谩s de compilar el typescript, se llevan los recursos a la carpeta build.

El resultado de la compilaci贸n queda en /build.

Para hacer un build:

npm run build

## Desplegar la aplicaci贸n 

Hacer:

npm start

## Instalaci贸n de nuevas librer铆as

Se realiza desde la ra铆z del proyecto, que contiene el archivo package.json:

npm install {nombre-libreria}

## Estructura del c贸digo fuente 

Tenemos las carpetas:

/helpers         Contiene clases de ayuda
/controllers     Contiene los controladores de la aplicaci贸n
/models          Contiene los modelos de la aplicaci贸n
/routes          Contienen las rutas
/views           Contienen las vistas hbs
app.config       Archivo de configuraci贸n de la aplicaci贸n
kudiska.js       Lanza la aplicaci贸n (punto de entrada)

## Configuraci贸n

Se encuentra en el archivo app.config.

Para obtener un valor de configuraci贸n:

    import { Config } from "./config";

Hacemos:

    const host:string = Config.get('mail.smtp.host');

Esto lee la siguiente clave del archivo de configuraci贸n:

    [mail.smtp]

    host=smtp.kudiska.com

## Entornos

La aplicaci贸n obtiene la configuraci贸n adecuada autom谩ticamente cuando se ejecuta en el entorno de desarrollo o de producci贸n.

Se puede obtener el entorno con:

    import { Environment } from './environment';

    const environment:Environment = Environment.get();

que puede vale Environment.Development cuando la aplicaic贸n se ejecuta en desarrollo y Environment.Production cuando se ejecuta en producci贸n.

## Rutas

El archivo principal de enrutamiento es:

/routes/router.ts

Para a帽adir un nuevo archivo de rutas, a帽adir una nueva sentencia al m茅todo Router, por ejemplo:

        /**
         * Manejador de rutas de usuarios
         *
         * @route /users/...
         */
        this.route.use('/users', require('./userRoute'));

Esto crea el grupo de rutas:

    /users/

y da el control a un nuevo archivo de rutas:

    /routes/userRoute.ts

Para crearlo podemos usar el modelo _exampleRouter.ts

    cp _exampleRouter.ts userRouter.ts

y reemplazar example por user:

    import { UserController } from '../controllers/userController';

    /**
    * userRoute
    * 
    * @author Jogeiker L <jogeiker1999@gmail.com>
    * @copyright Sapviremoto
    */

    /**
    * Carga el controlador
    */
    const userController = new UserController();

    /**
    * Habilita el Router
    */
    const UserRouter:any = userController.router();

    /**
    * index
    * 
    * Ruta por defecto
    * 
    * @route /example/
    * @method get
    */
    UserRouter.get('/', userController.index);

    module.exports = UserRouter;

M谩s adelante crearemos el controladore que maneje estas rutas UserController.ts

## Controladores 

Se ubican en:

    /contollers

Para crear un controlador nuevo usamos el ejemplo:

    cp _exampleController.ts UserController.ts

y susituimos example por user:

    import { BaseController } from './baseController';

    /**
    * UserController
    * 
    * Explica el objeto de este controlador
    *  
    * @author Jogeiker L <jogeiker1999@gmail.com>
    * @copyright Sapviremoto
    */
    
    export class UserController extends BaseController
    {
        /**
        * El constructor
        */
        public constructor()
        {
            // Llamamos al constructor padre
            super();
        }

        /**
        * Ruta por defecto
        * 
        * @route /example/
        * @method get
        */
        public index(request:any, response:any)
        {
            // Env铆a una respuesta
            response.send(`[OK] Mensaje de bienvenida enviado con 茅xito`);
        }
    }

Cada m茅todo del controlador es una acci贸n llamada por una ruta.

Por ejemplo, para crear la acci贸n /user/delete que elimina un usuario, debemos dar de alta la ruta en userRoute.ts:

    /**
    * delete
    * 
    * Borra un usuario
    * 
    * @route /user/delete
    * @method post
    */
    UserRouter.delete('/delete/:id', userController.delete);

Elegimos el m茅todo POST, puede usarse GET, DELETE.

y luego crear la acci贸n delete en userController.ts:

        /**
        * Borra un usuario
        * 
        * @route /user/delete
        * @method post
        */
        public delete(request:any, response:any)
        {
            // Env铆a una respuesta
            response.send(`[OK] Usuario eliminado con 茅xito`);
        }

## Modelos 

Se guardan en la carpeta models. Un ejemplo de modelo se ofrece en:

test.ts

Para todo sobre los modelos:

https://www.npmjs.com/package/ts-mongoose

Un modelo tiene la siguiente estructura b谩sica con tres partes:

1. Definir un esquema del modelo con el m茅todo createSchema:

    const schema = createSchema({
    ...
    });

2. Crear el objeto del modelo aplicado el m茅todo de factor铆a de clases typedModel. Esto genera la clase de objeto Test.

La forma b谩sica es:

        const Test = typedModel('Test', schema); 

Se suministra el nombre de la clase a crear y el esquema que hemos creado. Este m茅todo crea adem谩s la inferface correspondiente.

Una forma m谩s completa que permite crear m茅todos est谩ticos es:

    const Test = typedModel('Test', schema, undefined, undefined, 
        {
            /**
            * Obtiene el primer test con un nombre dado
            * 
            * @param {string} name     El nombre
            */
            findOneByName: function (name: string) {
                return this.findOne({ name : name });
            },

            /**
            * Obtiene todos los tests con un nombre dado
            * 
            * @param {string} name   El nombre
            */
            findByName: function (name: string) {
                return this.find({ name: name });
            },

            /**
            * Obtiene todos los tests de un fabircante dado
            * 
            * @param {string} vendor   El f谩bricante
            */
            findByVendor: function (vendor: string) {
                return this.find({ vendor: vendor });
            },
        }
    );

3. Exportar la clase creada para dejarla disponible.

    export default Test;

## Env铆o de Correo

Env铆o de un mensaje de correo sencillo:

    Mail.send(
        {
            to          : 'jogeiker1999@gmail.com', // Detinatario/s del mensaje
            subject     : 'test',            // El asunto
            message     : 'test'             // El mensaje
        }
    ).then(result => {
        
    }).catch(error => {
        console.error('Se ha producido un error al intentar enviar el correo');
    });

Env铆o de un mensaje de correo utilizando una plantilla ubicada en la carpeta /views/mail/:
        
    Mail.send(
        {
            to          : 'jogeiker1999@gmail.com', // Detinatario/s del mensaje
            subject     : 'test',            // El asunto
            template    : 'welcome'          // La plantilla /views/mail/welcome.html
            context     :
                {
                    name        : name,
                    lastname    : lastname,
                    email       : email
                }
        }
    ).then(result => {
        
    }).catch(error => {
        console.error('Se ha producido un error al intentar enviar el correo');
    });




# TAREAS DAVID:

 Crear modelo para manejo de esos 5 apartados:                                                                                                                                               
- 1- Crear modelo, con funciones normales de crud y que el delete solo cambie el estado.
- 2- Crear controlador para manejar este modelo.
- 3- Crear nueva ruta para manejar este controlador.
- 4- Agregar nueva ruta al controlador de la ruta.








































